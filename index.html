<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MyBookShare Inventory</title>
  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <!-- EmailJS library -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS with your user ID
    (function(){
      // TODO: Replace with your EmailJS user ID
      emailjs.init('YOUR_EMAILJS_USER_ID');
    })();
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }
    .book-item {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      background: #fafafa;
    }
    .book-item img {
      width: 100%;
      height: auto;
      object-fit: contain;
    }
    .book-title {
      font-weight: bold;
      margin-top: 8px;
    }
    .book-email {
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>MyBookShare Inventory</h1>
  <div>
    <label for="file-input">Upload book cover: </label>
    <input id="file-input" type="file" accept=".jpg,.jpeg,.png" />
  </div>
  <div>
    <label for="email-input">Your email (for interested readers to contact you): </label>
    <input id="email-input" type="email" placeholder="you@example.com" />
  </div>
  <button id="upload-btn">Upload & Scan</button>
  <div id="status"></div>

  <h2>Inventory</h2>
  <input id="search-input" type="text" placeholder="Search by title..." oninput="renderBooks()" />
  <div id="inventory-grid"></div>

  <script>
    // Array to hold book records; will persist via localStorage
    const books = [];

    function loadBooks() {
      const stored = localStorage.getItem('books');
      if (stored) {
        try {
          const arr = JSON.parse(stored);
          arr.forEach(b => books.push(b));
        } catch (e) {
          console.error('Error parsing stored books', e);
        }
      }
    }

    function saveBooks() {
      localStorage.setItem('books', JSON.stringify(books));
    }

    // Simple email validation
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(String(email).toLowerCase());
    }

    // Placeholder image moderation function
    async function isImageAppropriate(dataURL) {
      // In a production environment, integrate an external API to detect NSFW or graphic content
      // For now, always return true
      return true;
    }

    // Send confirmation email via EmailJS
    async function sendConfirmationEmail(email, title) {
      // TODO: Replace with your EmailJS service ID and template ID
      const serviceId = 'YOUR_SERVICE_ID';
      const templateId = 'YOUR_TEMPLATE_ID';
      const templateParams = {
        to_email: email,
        book_title: title
      };
      try {
        await emailjs.send(serviceId, templateId, templateParams);
        console.log('Confirmation email sent');
      } catch (error) {
        console.error('Failed to send confirmation email', error);
      }
    }

    async function processUpload() {
      const fileInput = document.getElementById('file-input');
      const emailInput = document.getElementById('email-input');
      const file = fileInput.files[0];
      const email = emailInput.value.trim();
      if (!file) {
        alert('Please choose an image (.jpg or .png).');
        return;
      }
      if (!validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
      }
      if (!['image/jpeg', 'image/png', 'image/jpg'].includes(file.type)) {
        alert('Only JPG and PNG images are allowed.');
        return;
      }
      const reader = new FileReader();
      reader.onload = async () => {
        const dataURL = reader.result;
        const appropriate = await isImageAppropriate(dataURL);
        if (!appropriate) {
          alert('The uploaded image appears inappropriate. Please upload a valid book cover.');
          return;
        }
        document.getElementById('status').textContent = 'Scanning image...';
        try {
          const result = await Tesseract.recognize(dataURL, 'eng', { logger: m => console.log(m) });
          const lines = result.data.text.split('\n').map(l => l.trim()).filter(Boolean);
          let title = lines.length ? lines[0] : 'Untitled';
          // Prompt user to confirm or edit the title
          title = prompt('Detected title:', title) || title;
          books.push({ title: title.trim(), image: dataURL, email: email });
          saveBooks();
          document.getElementById('status').textContent = 'Book added to inventory.';
          fileInput.value = '';
          emailInput.value = '';
          renderBooks();
          // Send confirmation email
          sendConfirmationEmail(email, title.trim());
        } catch (err) {
          console.error(err);
          document.getElementById('status').textContent = 'Error scanning image.';
        }
      };
      reader.readAsDataURL(file);
    }

    function renderBooks() {
      const container = document.getElementById('inventory-grid');
      container.innerHTML = '';
      const query = document.getElementById('search-input').value.toLowerCase();
      books.filter(book => book.title.toLowerCase().includes(query)).forEach(book => {
        const item = document.createElement('div');
        item.className = 'book-item';
        const img = document.createElement('img');
        img.src = book.image;
        img.alt = book.title;
        const titleDiv = document.createElement('div');
        titleDiv.className = 'book-title';
        titleDiv.textContent = book.title;
        const emailDiv = document.createElement('div');
        emailDiv.className = 'book-email';
        emailDiv.textContent = 'Contact: ' + book.email;
        item.appendChild(img);
        item.appendChild(titleDiv);
        item.appendChild(emailDiv);
        container.appendChild(item);
      });
    }

    document.getElementById('upload-btn').addEventListener('click', processUpload);

    // Initialize books from localStorage and render on page load
    loadBooks();
    renderBooks();
  </script>
</body>
</html>
