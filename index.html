<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MyBookShare Inventory</title>

  <!-- Load EmailJS and Supabase from CDN -->
  <script src="./config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!--
    CONFIG INSTRUCTIONS (IMPORTANT)

    This index.html does NOT hardcode keys anymore.
    It expects a global config object:

      window.MYBOOKSHARE_CONFIG = {
        SUPABASE_URL: "https://xxxx.supabase.co",
        SUPABASE_ANON_KEY: "your_anon_key",
        IMGBB_API_KEY: "your_imgbb_key",
        EMAILJS_PUBLIC_KEY: "your_emailjs_public_key",
        EMAILJS_SERVICE_ID: "service_xxx",
        EMAILJS_ADMIN_REVIEW_TEMPLATE_ID: "template_xxx",
        EMAILJS_APPROVAL_TEMPLATE_ID: "template_xxx",
        ADMIN_PASSWORD_SHA256: "sha256_hash_of_admin_password"
      };

    Options:
    1) Create a config.js in the SAME folder as index.html and add:
         window.MYBOOKSHARE_CONFIG = { ... };
       Then include it BEFORE this script runs. (Recommended for simplicity.)
       Example tag to add in <head> above:
         <script src="./config.js"></script>

    2) For quick testing, open DevTools console and paste:
         window.MYBOOKSHARE_CONFIG = { ... };
       then reload.

    NOTE: Anything used in browser is NOT truly secret.
  -->

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #265df0; color: #fff; }
    #header { background-color: #1e4bb8; display:flex; align-items:center; justify-content:center; padding:20px; }
    #header img { height: 50px; margin-right: 10px; }
    #header span { font-size: 1.8rem; font-weight: 600; }
    .container { padding: 20px; }

    .info-banner { background-color:#2196f3; color:#fff; padding:10px; margin:10px 0; border-radius:4px; font-size:0.9em; }
    .success-banner { background-color:#4caf50; color:#fff; padding:10px; margin:10px 0; border-radius:4px; font-size:0.9em; }
    .warning-banner { background-color:#ff9800; color:#000; padding:10px; margin:10px 0; border-radius:4px; font-size:0.9em; }

    .pending-badge { background-color:#ff9800; color:#000; padding:2px 8px; border-radius:3px; font-size:0.8em; font-weight:bold; }

    label { display:block; margin-bottom:8px; color:#fff; }
    input[type="file"], input[type="email"], input[type="password"], input[type="text"], button {
      margin-right:8px; padding:6px 10px; font-size:1rem;
    }
    button { cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }

    .approve-btn { background-color:#4caf50; color:white; border:none; border-radius:3px; padding:4px 8px; cursor:pointer; font-size:0.8em; margin-right:4px; }
    .approve-btn:hover { background-color:#45a049; }
    .reject-btn { background-color:#f44336; color:white; border:none; border-radius:3px; padding:4px 8px; cursor:pointer; font-size:0.8em; }
    .reject-btn:hover { background-color:#da190b; }

    #status { margin-top:10px; color:#c5d6ff; }
    #inventory-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:16px; margin-top:20px; }

    .book-item { background-color:#fff; color:#000; border:1px solid #ccc; border-radius:4px; padding:8px; text-align:center; position:relative; }
    .book-item.pending { border:2px solid #ff9800; background-color:#fff3e0; }
    .book-item img { width:100%; height:220px; object-fit:contain; border-bottom:1px solid #ddd; }

    .book-title { font-weight:bold; margin-top:8px; }
    .book-email { font-size:0.9em; color:#555; margin-top:4px; }

    .delete-btn { position:absolute; top:4px; right:4px; background-color:#ff4444; color:white; border:none; border-radius:3px; padding:4px 8px; cursor:pointer; font-size:0.8em; }
    .delete-btn:hover { background-color:#cc0000; }

    #search-input { padding:6px 10px; width:250px; margin-bottom:10px; color:#000; }
    #storage-info { margin-top:10px; font-size:0.9em; color:#c5d6ff; }

    .form-group { margin-bottom:15px; }
    .password-help { font-size:0.85em; color:#c5d6ff; margin-top:4px; }

    .loading-spinner {
      display:inline-block; width:14px; height:14px;
      border:2px solid #c5d6ff; border-top:2px solid #265df0;
      border-radius:50%; animation:spin 1s linear infinite; margin-left:8px;
    }
    @keyframes spin { 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }

    .admin-link { position:fixed; bottom:10px; right:10px; font-size:0.8em; color:#c5d6ff; text-decoration:none; }
    .admin-link:hover { color:#fff; }

    .back-button {
      display:inline-block; background-color:#fff; color:#1e4bb8;
      padding:10px 25px; border-radius:5px; text-decoration:none;
      font-weight:600; font-size:1rem; transition:all 0.3s ease;
    }
    .back-button:hover { background-color:#e3f2fd; transform:translateX(-3px); box-shadow:0 2px 8px rgba(0,0,0,0.2); }

    #admin-panel { background-color:#1e4bb8; padding:15px; margin:20px 0; border-radius:4px; display:none; }
    #admin-panel h3 { margin-top:0; }
    .pending-count { background-color:#ff9800; color:#000; padding:2px 8px; border-radius:10px; font-size:0.9em; margin-left:10px; }
  </style>
</head>

<body>
  <div id="header">
    <img src="images/logo.png" alt="My Book Share logo" onerror="this.style.display='none'">
    <span>mybookshare.com Inventory Page</span>
  </div>

  <div style="text-align:center; padding:15px 20px; background-color:#1e4bb8;">
    <a href="https://mybookshare.com" class="back-button">‚Üê Back to Main Site</a>
  </div>

  <div class="container">
    <div id="config-warning" class="warning-banner" style="display:none;">
      ‚ö†Ô∏è Site config not set. Please provide Supabase + ImgBB + EmailJS config.
      (See comments in index.html)
    </div>

    <div class="success-banner">Welcome to the Inventory Site!</div>

    <div class="info-banner">
      üìö All book uploads are reviewed by our team before appearing in the inventory.
      You'll receive an email once your book is approved!
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
      <h3>Admin Review Panel <span id="pending-count" class="pending-count">0</span></h3>
      <p>Review and approve pending book uploads below. Approved books will appear in the public inventory.</p>
      <div id="pending-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:16px;"></div>
    </div>

    <div>
      <div class="form-group">
        <label for="file-input">Upload book cover (JPG/PNG):</label>
        <input type="file" id="file-input" accept=".jpg,.jpeg,.png">
      </div>

      <div class="form-group">
        <label for="email-input">Your email (for interested readers to contact you):</label>
        <input type="email" id="email-input" placeholder="you@example.com">
      </div>

      <div class="form-group">
        <label for="password-input">Set a password (to delete your book later):</label>
        <input type="password" id="password-input" placeholder="Enter a password" minlength="4">
        <div class="password-help">
          Remember this password ‚Äî you'll need it to delete your book after it's approved. Minimum 4 characters.
        </div>
      </div>

      <button id="upload-button" type="button">Upload Book</button>
      <div id="status"></div>
      <div id="storage-info"></div>
    </div>

    <h2>Available Books</h2>
    <input type="text" id="search-input" placeholder="Search by title..." oninput="filterBooks()">
    <div id="inventory-grid"></div>
  </div>

  <a href="#" class="admin-link" onclick="enableAdminMode(); return false;">Admin</a>

  <script>
    // =========================
    // CONFIG LOADING
    // =========================
    const C = window.MYBOOKSHARE_CONFIG || {};

    const CONFIG = {
      SUPABASE_URL: C.SUPABASE_URL || 'YOUR_SUPABASE_URL',
      SUPABASE_ANON_KEY: C.SUPABASE_ANON_KEY || 'YOUR_SUPABASE_ANON_KEY',

      IMGBB_API_KEY: C.IMGBB_API_KEY || 'YOUR_IMGBB_API_KEY',

      EMAILJS_PUBLIC_KEY: C.EMAILJS_PUBLIC_KEY || 'YOUR_EMAILJS_PUBLIC_KEY',
      EMAILJS_SERVICE_ID: C.EMAILJS_SERVICE_ID || 'YOUR_EMAILJS_SERVICE_ID',
      EMAILJS_ADMIN_REVIEW_TEMPLATE_ID: C.EMAILJS_ADMIN_REVIEW_TEMPLATE_ID || 'YOUR_ADMIN_REVIEW_TEMPLATE_ID',
      EMAILJS_APPROVAL_TEMPLATE_ID: C.EMAILJS_APPROVAL_TEMPLATE_ID || 'YOUR_APPROVAL_TEMPLATE_ID',

      // Store only a SHA-256 hash for the admin password (still not ‚Äúsecure‚Äù, but avoids plaintext)
      ADMIN_PASSWORD_SHA256: C.ADMIN_PASSWORD_SHA256 || 'YOUR_ADMIN_PASSWORD_SHA256'
    };

    function isConfigured() {
      return (
        CONFIG.SUPABASE_URL !== 'YOUR_SUPABASE_URL' &&
        CONFIG.SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY' &&
        CONFIG.IMGBB_API_KEY !== 'YOUR_IMGBB_API_KEY' &&
        CONFIG.EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY' &&
        CONFIG.EMAILJS_SERVICE_ID !== 'YOUR_EMAILJS_SERVICE_ID'
      );
    }

    // Initialize EmailJS (public key)
    try {
      if (CONFIG.EMAILJS_PUBLIC_KEY && CONFIG.EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY') {
        emailjs.init(CONFIG.EMAILJS_PUBLIC_KEY);
      }
    } catch (e) {
      console.warn('EmailJS init failed:', e);
    }

    // Initialize Supabase client
    const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    // =========================
    // MAIN APP STATE
    // =========================
    let adminMode = false;
    let books = [];

    window.addEventListener('load', async function () {
      if (!isConfigured()) {
        document.getElementById('config-warning').style.display = 'block';
      }

      try {
        await loadBooks();
      } catch (e) {
        console.error('Initial loadBooks failed:', e);
      }

      renderBooks();

      const urlParams = new URLSearchParams(window.location.search);
      const reviewId = urlParams.get('review');
      if (reviewId) {
        alert('Please click "Admin" in the bottom-right corner to review pending uploads.');
      }
    });

    // =========================
    // HELPERS
    // =========================
    function validateEmail(email) {
      const re = /^\S+@\S+\.\S+$/;
      return re.test(email);
    }

    async function sha256Hex(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function hashPassword(password) {
      return sha256Hex(password);
    }

    // =========================
    // EMAILS
    // =========================
    function sendAdminReviewEmail(userEmail, title, bookId) {
      const adminEmail = (C.ADMIN_EMAIL || 'YOUR_ADMIN_EMAIL'); // optional
      const reviewUrl = window.location.origin + window.location.pathname + '?review=' + bookId;

      const params = {
        to_email: adminEmail,
        admin_email: adminEmail,
        user_email: userEmail,
        book_title: title,
        upload_date: new Date().toLocaleString(),
        review_url: reviewUrl,
        book_id: bookId
      };

      return emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_ADMIN_REVIEW_TEMPLATE_ID, params)
        .then(r => true)
        .catch(err => {
          console.error('Admin email failed:', err);
          return false;
        });
    }

    function sendApprovalNotificationEmail(email, title) {
      const params = {
        to_email: email,
        user_email: email,
        book_title: title,
        site_url: window.location.origin + window.location.pathname
      };

      return emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_APPROVAL_TEMPLATE_ID, params)
        .then(r => true)
        .catch(err => {
          console.error('Approval email failed:', err);
          return false;
        });
    }

    // =========================
    // IMGBB UPLOAD
    // =========================
    async function uploadToImgBB(file) {
      const formData = new FormData();
      formData.append('image', file);

      const response = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.IMGBB_API_KEY}`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        let errorData = null;
        try { errorData = await response.json(); } catch {}
        throw new Error(`ImgBB upload failed: ${errorData?.error?.message || response.statusText}`);
      }

      const data = await response.json();
      return data.data.url;
    }

    // =========================
    // SUPABASE CRUD
    // =========================
    async function loadBooks() {
      // timeout guard
      const timeout = new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Supabase query timed out after 10 seconds')), 10000)
      );

      const query = supabaseClient
        .from('books')
        // IMPORTANT: never select '*' because it would expose password_hash and can trigger RLS/401
        .select('id,title,email,image_url,upload_date,status,approved_date')
        .order('upload_date', { ascending: false });

      const { data, error } = await Promise.race([query, timeout]);

      if (error) throw error;

      books = data || [];
      updateStorageInfo();
    }

    async function saveBook(book) {
      const { data, error } = await supabaseClient
        .from('books')
        .insert([book])
        // Return only non-sensitive columns
        .select('id,title,email,image_url,upload_date,status');

      if (error) throw error;
      return data[0];
    }

    async function updateBook(id, updates) {
      const { data, error } = await supabaseClient
        .from('books')
        .update(updates)
        .eq('id', id)
        // Return only non-sensitive columns
        .select('id,title,email,image_url,upload_date,status,approved_date');

      if (error) throw error;
      return data[0];
    }

    async function deleteBookOwnerFromDB(id, passwordPlaintext) {
      const { error } = await supabaseClient
        .rpc('delete_book_with_password', { p_id: id, p_password: passwordPlaintext });

      if (error) throw error;
      return true;
    }

    async function deleteBookAdminFromDB(id) {
      const { error } = await supabaseClient
        .from('books')
        .delete()
        .eq('id', id);

      if (error) throw error;
      return true;
    }

    function updateStorageInfo() {
      const info = document.getElementById('storage-info');
      const approvedCount = books.filter(b => b.status === 'approved').length;
      const pendingCount = books.filter(b => b.status === 'pending').length;

      info.textContent = `Books: ${approvedCount} approved, ${pendingCount} pending | Database: Supabase`;

      if (adminMode) {
        document.getElementById('pending-count').textContent = pendingCount;
      }
    }

    // =========================
    // ADMIN ACTIONS
    // =========================
    async function approveBook(id) {
      const book = books.find(b => b.id === id);
      if (!book) return;

      if (confirm(`Approve "${book.title}" by ${book.email}?`)) {
        const updated = await updateBook(id, {
          status: 'approved',
          approved_date: new Date().toISOString()
        });

        if (updated) {
          await loadBooks();
          renderBooks();
          renderPendingBooks();
          await sendApprovalNotificationEmail(book.email, book.title);
          alert('Book approved! User will be notified by email.');
        }
      }
    }

    async function rejectBook(id) {
      const book = books.find(b => b.id === id);
      if (!book) return;

      if (confirm(`Reject and delete "${book.title}" by ${book.email}?`)) {
        const deleted = await deleteBookAdminFromDB(id);
        if (deleted) {
          await loadBooks();
          renderBooks();
          renderPendingBooks();
          alert('Book rejected and deleted.');
        }
      }
    }

    async function deleteBook(id) {
      const book = books.find(b => b.id === id);
      if (!book) return;

      if (adminMode) {
        if (confirm(`[ADMIN MODE] Delete "${book.title}" uploaded by ${book.email}?`)) {
          const deleted = await deleteBookAdminFromDB(id);
          if (deleted) {
            await loadBooks();
            renderBooks();
            renderPendingBooks();
            alert('Book deleted by administrator.');
          }
        }
        return;
      }

      const password = prompt(`Enter the password you set when you uploaded "${book.title}":`);
      if (!password) return;

      if (confirm('Are you sure you want to delete this book?')) {
        try {
          // Server-side function validates the password.
          // We intentionally do NOT fetch password_hash to the browser.
          const deleted = await deleteBookOwnerFromDB(id, password);
          if (deleted) {
            await loadBooks();
            renderBooks();
            alert('Book deleted successfully!');
          }
        } catch (err) {
          console.error(err);
          alert('Delete failed: ' + (err?.message || 'Incorrect password or unknown error'));
        }
      }
    }

    async function enableAdminMode() {
      const password = prompt('Enter admin password:');
      if (!password) return;

      const enteredHash = await sha256Hex(password);

      if (CONFIG.ADMIN_PASSWORD_SHA256 !== 'YOUR_ADMIN_PASSWORD_SHA256' &&
          enteredHash === CONFIG.ADMIN_PASSWORD_SHA256) {

        adminMode = true;
        document.getElementById('admin-panel').style.display = 'block';
        alert('Admin mode enabled. You can now review pending uploads and manage all books.');
        renderBooks();
        renderPendingBooks();
        updateStorageInfo();

      } else {
        alert('Incorrect admin password (or admin hash not configured).');
      }
    }

    // =========================
    // RENDERING
    // =========================
    function renderPendingBooks() {
      const grid = document.getElementById('pending-grid');
      grid.innerHTML = '';

      const pendingBooks = books.filter(b => b.status === 'pending');

      if (pendingBooks.length === 0) {
        grid.innerHTML = '<p style="color:#c5d6ff;">No pending uploads to review.</p>';
        return;
      }

      pendingBooks.forEach((book) => {
        const item = document.createElement('div');
        item.className = 'book-item pending';

        const img = document.createElement('img');
        img.src = book.image_url;
        img.alt = book.title;

        const titleEl = document.createElement('div');
        titleEl.className = 'book-title';
        titleEl.textContent = book.title;

        const emailEl = document.createElement('div');
        emailEl.className = 'book-email';
        emailEl.textContent = 'Uploader: ' + book.email;

        const dateEl = document.createElement('div');
        dateEl.style.fontSize = '0.8em';
        dateEl.style.color = '#666';
        dateEl.style.marginTop = '4px';
        dateEl.textContent = 'Uploaded: ' + new Date(book.upload_date).toLocaleDateString();

        const buttonContainer = document.createElement('div');
        buttonContainer.style.marginTop = '8px';

        const approveBtn = document.createElement('button');
        approveBtn.className = 'approve-btn';
        approveBtn.textContent = '‚úì Approve';
        approveBtn.onclick = () => approveBook(book.id);

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'reject-btn';
        rejectBtn.textContent = '‚úó Reject';
        rejectBtn.onclick = () => rejectBook(book.id);

        buttonContainer.appendChild(approveBtn);
        buttonContainer.appendChild(rejectBtn);

        item.appendChild(img);
        item.appendChild(titleEl);
        item.appendChild(emailEl);
        item.appendChild(dateEl);
        item.appendChild(buttonContainer);

        grid.appendChild(item);
      });
    }

    function renderBooks() {
      const grid = document.getElementById('inventory-grid');
      grid.innerHTML = '';

      const visibleBooks = adminMode ? books : books.filter(b => b.status === 'approved');

      if (visibleBooks.length === 0) {
        grid.innerHTML = '<p style="color:#c5d6ff; grid-column:1 / -1;">No books available yet. Check back soon!</p>';
        return;
      }

      visibleBooks.forEach((book) => {
        const item = document.createElement('div');
        item.className = 'book-item';
        if (book.status === 'pending') item.classList.add('pending');

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = adminMode ? 'Admin Delete' : 'Delete';
        deleteBtn.onclick = () => deleteBook(book.id);

        const img = document.createElement('img');
        img.src = book.image_url;
        img.alt = book.title;
        img.onerror = function () {
          this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="180" height="220"%3E%3Crect fill="%23ddd" width="180" height="220"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999"%3EImage not found%3C/text%3E%3C/svg%3E';
        };

        const titleEl = document.createElement('div');
        titleEl.className = 'book-title';
        titleEl.innerHTML = book.title;
        if (book.status === 'pending' && adminMode) {
          titleEl.innerHTML += ' <span class="pending-badge">PENDING</span>';
        }

        const emailEl = document.createElement('div');
        emailEl.className = 'book-email';
        emailEl.textContent = 'Contact: ' + book.email;

        item.appendChild(deleteBtn);
        item.appendChild(img);
        item.appendChild(titleEl);
        item.appendChild(emailEl);

        grid.appendChild(item);
      });

      updateStorageInfo();
    }

    function filterBooks() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const grid = document.getElementById('inventory-grid');
      grid.innerHTML = '';

      const visibleBooks = adminMode ? books : books.filter(b => b.status === 'approved');
      const filtered = visibleBooks.filter(book => (book.title || '').toLowerCase().includes(query));

      if (filtered.length === 0) {
        grid.innerHTML = '<p style="color:#c5d6ff; grid-column:1 / -1;">No books found matching your search.</p>';
        return;
      }

      filtered.forEach((book) => {
        const item = document.createElement('div');
        item.className = 'book-item';
        if (book.status === 'pending') item.classList.add('pending');

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = adminMode ? 'Admin Delete' : 'Delete';
        deleteBtn.onclick = () => deleteBook(book.id);

        const img = document.createElement('img');
        img.src = book.image_url;
        img.alt = book.title;
        img.onerror = function () {
          this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="180" height="220"%3E%3Crect fill="%23ddd" width="180" height="220"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999"%3EImage not found%3C/text%3E%3C/svg%3E';
        };

        const titleEl = document.createElement('div');
        titleEl.className = 'book-title';
        titleEl.innerHTML = book.title;
        if (book.status === 'pending' && adminMode) {
          titleEl.innerHTML += ' <span class="pending-badge">PENDING</span>';
        }

        const emailEl = document.createElement('div');
        emailEl.className = 'book-email';
        emailEl.textContent = 'Contact: ' + book.email;

        item.appendChild(deleteBtn);
        item.appendChild(img);
        item.appendChild(titleEl);
        item.appendChild(emailEl);

        grid.appendChild(item);
      });
    }

    // =========================
    // UPLOAD FLOW
    // =========================
    async function processUpload() {
      const fileInput = document.getElementById('file-input');
      const emailInput = document.getElementById('email-input');
      const passwordInput = document.getElementById('password-input');
      const uploadButton = document.getElementById('upload-button');
      const status = document.getElementById('status');

      if (!isConfigured()) {
        alert('Site config is missing. Set window.MYBOOKSHARE_CONFIG and reload.');
        return;
      }

      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select an image file (.jpg or .png).');
        return;
      }

      const file = fileInput.files[0];

      if (!['image/jpeg', 'image/png'].includes(file.type)) {
        alert('Only JPG and PNG images are allowed.');
        return;
      }

      const maxSize = 32 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('Image file is too large. Please use an image smaller than 32MB.');
        return;
      }

      const email = emailInput.value.trim();
      if (!validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
      }

      const password = passwordInput.value.trim();
      if (!password || password.length < 4) {
        alert('Please enter a password (minimum 4 characters).');
        return;
      }

      uploadButton.disabled = true;

      try {
        let title = '';
        while (!title || title.trim() === '') {
          title = prompt('Enter the book title (required):');
          if (title === null) {
            alert('Book title is required. Upload cancelled.');
            uploadButton.disabled = false;
            status.textContent = '';
            return;
          }
          title = title.trim();
          if (title === '') alert('Book title cannot be empty. Please enter a title.');
        }

        status.innerHTML = 'Uploading image to ImgBB... <span class="loading-spinner"></span>';
        const imageUrl = await uploadToImgBB(file);

        status.innerHTML = 'Hashing password... <span class="loading-spinner"></span>';
        const passwordHash = await hashPassword(password);

        const bookId = Date.now().toString();

        const book = {
          id: bookId,
          title: title,
          email: email,
          image_url: imageUrl,
          password_hash: passwordHash,
          upload_date: new Date().toISOString(),
          status: 'pending'
        };

        status.innerHTML = 'Saving to database... <span class="loading-spinner"></span>';
        const savedBook = await saveBook(book);

        if (savedBook) {
          await loadBooks();
          renderBooks();
          if (adminMode) renderPendingBooks();

          status.textContent = 'Sending admin notification...';
          const emailSent = await sendAdminReviewEmail(email, title, bookId);

          status.textContent = emailSent
            ? 'Book submitted for review! The administrator has been notified.'
            : 'Book saved, but email notification failed. Check console.';

          fileInput.value = '';
          emailInput.value = '';
          passwordInput.value = '';
        } else {
          status.textContent = 'Failed to save book to database.';
        }
      } catch (err) {
        console.error(err);
        status.textContent = 'Error: ' + err.message;
        alert('Upload failed: ' + err.message + '\n\nCheck browser console (F12) for details.');
      } finally {
        uploadButton.disabled = false;
      }
    }

    document.getElementById('upload-button').addEventListener('click', processUpload);
  </script>
</body>
</html>
