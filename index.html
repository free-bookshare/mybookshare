<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MyBookShare Inventory</title>
  <!-- Load Tesseract.js and EmailJS from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <!-- Load TensorFlow.js and NSFWJS for content moderation - UPDATED VERSIONS -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nsfwjs@2.4.2/dist/nsfwjs.min.js"></script>
  <script>
    (function() {
      // Initialize EmailJS - REPLACE WITH YOUR ACTUAL USER ID FROM EMAILJS.COM
      emailjs.init('YOUR_EMAILJS_USER_ID');
    })();
  </script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #265df0; /* professional blue */
      color: #fff;
    }
    #header {
      background-color: #1e4bb8;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #header img {
      height: 50px;
      margin-right: 10px;
    }
    #header span {
      font-size: 1.8rem;
      font-weight: 600;
    }
    .container {
      padding: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #fff;
    }
    input[type="file"],
    input[type="email"],
    input[type="password"],
    input[type="text"],
    button {
      margin-right: 8px;
      padding: 6px 10px;
      font-size: 1rem;
    }
    button {
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #status {
      margin-top: 10px;
      color: #c5d6ff;
    }
    .warning-banner {
      background-color: #ff9800;
      color: #000;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    #inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .book-item {
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      text-align: center;
      position: relative;
    }
    .book-item img {
      width: 100%;
      height: 220px;
      object-fit: contain;
      border-bottom: 1px solid #ddd;
    }
    .book-title {
      font-weight: bold;
      margin-top: 8px;
    }
    .book-email {
      font-size: 0.9em;
      color: #555;
      margin-top: 4px;
    }
    .delete-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .delete-btn:hover {
      background-color: #cc0000;
    }
    #search-input {
      padding: 6px 10px;
      width: 250px;
      margin-bottom: 10px;
      color: #000;
    }
    #storage-info {
      margin-top: 10px;
      font-size: 0.9em;
      color: #c5d6ff;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .password-help {
      font-size: 0.85em;
      color: #c5d6ff;
      margin-top: 4px;
    }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #c5d6ff;
      border-top: 2px solid #265df0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .admin-link {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 0.8em;
      color: #c5d6ff;
      text-decoration: none;
    }
    .admin-link:hover {
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="header">
    <!-- Logo must exist at /images/logo.png in your repository -->
    <img src="images/logo.png" alt="My Book Share logo" onerror="this.style.display='none'">
    <span>mybookshare.com Inventory Page</span>
  </div>
  <div class="container">
    <div id="moderation-warning" class="warning-banner" style="display:none;">
      ⚠️ Content moderation is currently unavailable. Please only upload appropriate book cover images.
    </div>
    
    <div>
      <div class="form-group">
        <label for="file-input">Upload book cover (JPG/PNG):</label>
        <input type="file" id="file-input" accept=".jpg,.jpeg,.png">
      </div>
      
      <div class="form-group">
        <label for="email-input">Your email (for interested readers to contact you):</label>
        <input type="email" id="email-input" placeholder="you@example.com">
      </div>
      
      <div class="form-group">
        <label for="password-input">Set a password (to delete your book later):</label>
        <input type="password" id="password-input" placeholder="Enter a password" minlength="4">
        <div class="password-help">Remember this password - you'll need it to delete your book after giving it away. Minimum 4 characters.</div>
      </div>
      
      <button id="upload-button" type="button">Upload &amp; Scan</button>
      <div id="status"></div>
      <div id="storage-info"></div>
    </div>
    <h2>Inventory</h2>
    <input type="text" id="search-input" placeholder="Search by title..." oninput="filterBooks()">
    <div id="inventory-grid"></div>
  </div>
  
  <a href="#" class="admin-link" onclick="enableAdminMode(); return false;">Admin</a>
  
  <script>
    // Admin mode variables
    let adminMode = false;
    const ADMIN_PASSWORD = 'admin123'; // CHANGE THIS TO A SECURE PASSWORD
    
    // NSFW model instance - loaded once on page load
    let nsfwModel = null;
    let modelLoadAttempted = false;
    
    // Load the NSFW model on page load with retry logic
    async function loadNSFWModel() {
      if (modelLoadAttempted) return;
      modelLoadAttempted = true;
      
      try {
        console.log('Loading NSFW detection model...');
        
        // Check if TensorFlow.js loaded
        if (typeof tf === 'undefined') {
          throw new Error('TensorFlow.js failed to load');
        }
        
        // Check if NSFWJS loaded
        if (typeof nsfwjs === 'undefined') {
          throw new Error('NSFWJS library failed to load');
        }
        
        // Try to load the model with timeout
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Model loading timeout')), 30000)
        );
        
        nsfwModel = await Promise.race([
          nsfwjs.load(),
          timeoutPromise
        ]);
        
        console.log('NSFW model loaded successfully');
        
      } catch (err) {
        console.error('Error loading NSFW model:', err);
        
        // Show warning banner instead of alert
        const warningBanner = document.getElementById('moderation-warning');
        if (warningBanner) {
          warningBanner.style.display = 'block';
        }
        
        // Model failed to load, but we'll continue without it
        nsfwModel = null;
      }
    }

    // Check if image is appropriate using NSFWJS
    async function isImageAppropriate(imgElement) {
      // If model didn't load, skip verification but log it
      if (!nsfwModel) {
        console.warn('NSFW model not available - skipping content verification');
        return true; // Allow upload but warn user
      }
      
      try {
        const predictions = await nsfwModel.classify(imgElement);
        console.log('NSFW predictions:', predictions);
        
        // predictions is an array of {className, probability}
        // Classes: 'Drawing', 'Hentai', 'Neutral', 'Porn', 'Sexy'
        
        // Find the probabilities for inappropriate content
        const porn = predictions.find(p => p.className === 'Porn');
        const hentai = predictions.find(p => p.className === 'Hentai');
        const sexy = predictions.find(p => p.className === 'Sexy');
        
        // Set thresholds (adjust these values as needed)
        const PORN_THRESHOLD = 0.60;  // 60% confidence
        const HENTAI_THRESHOLD = 0.60; // 60% confidence
        const SEXY_THRESHOLD = 0.80;   // 80% confidence (more lenient for book covers with people)
        
        // Reject if any inappropriate category exceeds threshold
        if (porn && porn.probability > PORN_THRESHOLD) {
          console.log(`Image rejected: Porn probability ${(porn.probability * 100).toFixed(1)}%`);
          return false;
        }
        
        if (hentai && hentai.probability > HENTAI_THRESHOLD) {
          console.log(`Image rejected: Hentai probability ${(hentai.probability * 100).toFixed(1)}%`);
          return false;
        }
        
        if (sexy && sexy.probability > SEXY_THRESHOLD) {
          console.log(`Image rejected: Sexy probability ${(sexy.probability * 100).toFixed(1)}%`);
          return false;
        }
        
        return true;
        
      } catch (err) {
        console.error('Error checking image:', err);
        return true; // Allow upload on error rather than blocking
      }
    }

    // Hash password using SHA-256
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    function validateEmail(email) {
      const re = /^\S+@\S+\.\S+$/;
      return re.test(email);
    }

    // Send confirmation email to the user who uploaded
    function sendUserConfirmationEmail(email, title) {
      // REPLACE WITH YOUR EMAILJS SERVICE ID AND TEMPLATE ID
      // Template should include variables: {{user_email}}, {{book_title}}, {{upload_date}}
      const serviceID = 'YOUR_SERVICE_ID';
      const templateID = 'YOUR_USER_CONFIRMATION_TEMPLATE_ID';
      const params = {
        to_email: email,
        user_email: email,
        book_title: title,
        upload_date: new Date().toLocaleString()
      };
      return emailjs.send(serviceID, templateID, params)
        .then(function(response) {
          console.log('User confirmation email sent', response.status, response.text);
        })
        .catch(function(error) {
          console.error('User confirmation email error', error);
        });
    }

    // Send notification email to admin
    function sendAdminNotificationEmail(email, title) {
      // REPLACE WITH YOUR EMAILJS SERVICE ID AND TEMPLATE ID
      // Template should include variables: {{admin_email}}, {{user_email}}, {{book_title}}, {{upload_date}}
      const serviceID = 'YOUR_SERVICE_ID';
      const templateID = 'YOUR_ADMIN_NOTIFICATION_TEMPLATE_ID';
      const adminEmail = 'zdjimas@ctadmin.com';
      const params = {
        to_email: adminEmail,
        admin_email: adminEmail,
        user_email: email,
        book_title: title,
        upload_date: new Date().toLocaleString()
      };
      return emailjs.send(serviceID, templateID, params)
        .then(function(response) {
          console.log('Admin notification email sent', response.status, response.text);
        })
        .catch(function(error) {
          console.error('Admin notification email error', error);
        });
    }

    // Book entries stored in memory and persisted to localStorage
    let books = [];

    function loadBooks() {
      try {
        const stored = localStorage.getItem('books');
        if (stored) {
          books = JSON.parse(stored);
          updateStorageInfo();
        }
      } catch (e) {
        console.error('Error loading books:', e);
        if (e.name === 'QuotaExceededError') {
          alert('Storage quota exceeded. Please delete some books.');
        }
      }
    }

    function saveBooks() {
      try {
        localStorage.setItem('books', JSON.stringify(books));
        updateStorageInfo();
      } catch (e) {
        console.error('Error saving books:', e);
        if (e.name === 'QuotaExceededError') {
          alert('Storage quota exceeded. Cannot save more books. Please delete some existing entries.');
          return false;
        }
      }
      return true;
    }

    function updateStorageInfo() {
      const info = document.getElementById('storage-info');
      const booksCount = books.length;
      const storageSize = new Blob([localStorage.getItem('books') || '']).size;
      const storageMB = (storageSize / (1024 * 1024)).toFixed(2);
      info.textContent = `Books stored: ${booksCount} | Storage used: ${storageMB} MB`;
    }

    async function deleteBook(index) {
      const book = books[index];
      
      // If admin mode is enabled, allow direct deletion
      if (adminMode) {
        if (confirm(`[ADMIN MODE] Delete "${book.title}" uploaded by ${book.email}?`)) {
          books.splice(index, 1);
          saveBooks();
          renderBooks();
          alert('Book deleted by administrator.');
        }
        return;
      }
      
      // Normal user deletion - requires password
      const password = prompt(`Enter the password you set when you uploaded "${book.title}":`);
      
      if (!password) {
        return; // User cancelled
      }
      
      const hashedInput = await hashPassword(password);
      
      if (hashedInput === book.passwordHash) {
        if (confirm('Are you sure you want to delete this book?')) {
          books.splice(index, 1);
          saveBooks();
          renderBooks();
          alert('Book deleted successfully!');
        }
      } else {
        alert('Incorrect password. Only the owner can delete this book.');
      }
    }

    function enableAdminMode() {
      const password = prompt('Enter admin password:');
      if (password === ADMIN_PASSWORD) {
        adminMode = true;
        alert('Admin mode enabled. You can now delete any book without a password.');
        renderBooks(); // Refresh display
      } else {
        alert('Incorrect admin password.');
      }
    }

    function renderBooks() {
      const grid = document.getElementById('inventory-grid');
      grid.innerHTML = '';
      books.forEach((book, index) => {
        const item = document.createElement('div');
        item.className = 'book-item';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = adminMode ? 'Admin Delete' : 'Delete';
        deleteBtn.onclick = () => deleteBook(index);
        
        const img = document.createElement('img');
        // Use the stored base64 data URL
        img.src = book.imageData;
        img.onerror = function() {
          this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="180" height="220"%3E%3Crect fill="%23ddd" width="180" height="220"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999"%3ENo Image%3C/text%3E%3C/svg%3E';
        };
        
        const titleEl = document.createElement('div');
        titleEl.className = 'book-title';
        titleEl.textContent = book.title;
        
        const emailEl = document.createElement('div');
        emailEl.className = 'book-email';
        emailEl.textContent = 'Contact: ' + book.email;
        
        item.appendChild(deleteBtn);
        item.appendChild(img);
        item.appendChild(titleEl);
        item.appendChild(emailEl);
        grid.appendChild(item);
      });
    }

    function filterBooks() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const grid = document.getElementById('inventory-grid');
      grid.innerHTML = '';
      books.filter(book => book.title.toLowerCase().includes(query)).forEach((book, index) => {
        const item = document.createElement('div');
        item.className = 'book-item';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = adminMode ? 'Admin Delete' : 'Delete';
        deleteBtn.onclick = () => deleteBook(index);
        
        const img = document.createElement('img');
        img.src = book.imageData;
        img.onerror = function() {
          this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="180" height="220"%3E%3Crect fill="%23ddd" width="180" height="220"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999"%3ENo Image%3C/text%3E%3C/svg%3E';
        };
        
        const titleEl = document.createElement('div');
        titleEl.className = 'book-title';
        titleEl.textContent = book.title;
        
        const emailEl = document.createElement('div');
        emailEl.className = 'book-email';
        emailEl.textContent = 'Contact: ' + book.email;
        
        item.appendChild(deleteBtn);
        item.appendChild(img);
        item.appendChild(titleEl);
        item.appendChild(emailEl);
        grid.appendChild(item);
      });
    }

    async function processUpload() {
      const fileInput = document.getElementById('file-input');
      const emailInput = document.getElementById('email-input');
      const passwordInput = document.getElementById('password-input');
      const uploadButton = document.getElementById('upload-button');
      const status = document.getElementById('status');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select an image file (.jpg or .png).');
        return;
      }
      
      const file = fileInput.files[0];
      if (!['image/jpeg', 'image/png'].includes(file.type)) {
        alert('Only JPG and PNG images are allowed.');
        return;
      }
      
      // Check file size (limit to 2MB per image to avoid storage issues)
      const maxSize = 2 * 1024 * 1024; // 2MB
      if (file.size > maxSize) {
        alert('Image file is too large. Please use an image smaller than 2MB.');
        return;
      }
      
      const email = emailInput.value.trim();
      if (!validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
      }
      
      const password = passwordInput.value.trim();
      if (!password || password.length < 4) {
        alert('Please enter a password (minimum 4 characters). You will need this to delete your book later.');
        return;
      }
      
      // Disable upload button during processing
      uploadButton.disabled = true;
      
      // Read file as data URL
      const reader = new FileReader();
      reader.onload = async function(e) {
        const dataUrl = e.target.result;
        
        // Create an image element for NSFW checking
        if (nsfwModel) {
          status.innerHTML = 'Checking image content... <span class="loading-spinner"></span>';
        } else {
          status.innerHTML = 'Processing image... <span class="loading-spinner"></span>';
        }
        
        const img = new Image();
        
        img.onload = async function() {
          // Check if image is appropriate (only if model loaded)
          const isAppropriate = await isImageAppropriate(img);
          
          if (!isAppropriate) {
            alert('This image does not meet our content guidelines. Please upload a book cover image only.');
            status.textContent = 'Upload rejected - inappropriate content detected.';
            uploadButton.disabled = false;
            return;
          }
          
          status.innerHTML = 'Scanning image for text… <span class="loading-spinner"></span>';
          
          try {
            const result = await Tesseract.recognize(dataUrl, 'eng', { logger: m => console.log(m) });
            status.textContent = 'Scan complete.';
            
            const lines = result.data.text.split('\n').map(l => l.trim()).filter(Boolean);
            let detectedTitle = lines.length > 0 ? lines.slice(0, 3).join(' ').substring(0, 100) : '';
            
            // REQUIRED: User must enter a title - cannot leave blank or cancel
            let title = '';
            while (!title || title.trim() === '') {
              title = prompt('Enter the book title (required):', detectedTitle);
              if (title === null) {
                // User clicked cancel
                alert('Book title is required. Upload cancelled.');
                uploadButton.disabled = false;
                return;
              }
              title = title.trim();
              if (title === '') {
                alert('Book title cannot be empty. Please enter a title.');
              }
            }
            
            // Hash the password
            const passwordHash = await hashPassword(password);
            
            // Create book entry with image data stored as base64
            const book = {
              title: title,
              email: email,
              imageData: dataUrl, // Store the actual image data
              passwordHash: passwordHash, // Store hashed password
              uploadDate: new Date().toISOString()
            };
            
            books.push(book);
            
            // Try to save
            if (saveBooks()) {
              renderBooks();
              
              // Send confirmation email to user
              status.textContent = 'Sending confirmation emails...';
              try {
                await sendUserConfirmationEmail(email, title);
                await sendAdminNotificationEmail(email, title);
              } catch (emailError) {
                console.error('Email sending error:', emailError);
                // Continue even if emails fail - book is still saved
              }
              
              // Reset inputs
              fileInput.value = '';
              emailInput.value = '';
              passwordInput.value = '';
              status.textContent = 'Book successfully added! Confirmation emails sent.';
            } else {
              // Remove the book we just added since save failed
              books.pop();
              status.textContent = 'Failed to save book. Storage may be full.';
            }
          } catch (err) {
            console.error(err);
            status.textContent = 'Error scanning image: ' + err.message;
          } finally {
            uploadButton.disabled = false;
          }
        };
        
        img.onerror = function() {
          alert('Error loading image for content verification.');
          status.textContent = 'Upload failed - could not load image.';
          uploadButton.disabled = false;
        };
        
        img.src = dataUrl;
      };
      
      reader.readAsDataURL(file);
    }

    document.getElementById('upload-button').addEventListener('click', processUpload);

    // Initialize - load NSFW model and books
    loadNSFWModel();
    loadBooks();
    renderBooks();
  </script>
</body>
</html>
