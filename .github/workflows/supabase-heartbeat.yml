name: Supabase Heartbeat

on:
  schedule:
    # Mon & Fri 06:00 UTC
    - cron: "0 6 * * 1,5"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Validate Supabase secrets (fail fast)
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${SUPABASE_URL:-}" ]; then
            echo "ERROR: SUPABASE_URL secret is missing or empty."
            exit 1
          fi

          if [ -z "${SUPABASE_ANON_KEY:-}" ]; then
            echo "ERROR: SUPABASE_ANON_KEY secret is missing or empty."
            exit 1
          fi

          case "$SUPABASE_URL" in
            https://*) ;; 
            *)
              echo "ERROR: SUPABASE_URL must start with https://"
              exit 1
              ;;
          esac

          echo "Supabase URL length: ${#SUPABASE_URL}"
          echo "Supabase anon key present (length: ${#SUPABASE_ANON_KEY})"

      - name: Ping Supabase REST API (books)
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail

          endpoint="${SUPABASE_URL%/}/rest/v1/books?select=id&limit=1"
          echo "Pinging: ${endpoint}"

          code=$(curl -sS -o /dev/null -w "%{http_code}"             "$endpoint"             -H "apikey: ${SUPABASE_ANON_KEY}"             -H "Authorization: Bearer ${SUPABASE_ANON_KEY}")

          echo "HTTP status: $code"

          if [ "$code" -ne 200 ] && [ "$code" -ne 206 ]; then
            echo "ERROR: Unexpected HTTP status from Supabase: $code"
            exit 1
          fi
